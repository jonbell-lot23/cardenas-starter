#!/bin/bash
# Health trend analyzer - find patterns and correlations
# Usage: health-analyze [week|month|all]

set -euo pipefail

HEALTH_DIR="$HOME/cmd/cardenas/health-mood/daily"
TIMEFRAME="${1:-week}"

case "$TIMEFRAME" in
    today)
        FILES=("$HEALTH_DIR/$(date +%Y-%m-%d).json")
        ;;
    week)
        FILES=($(find "$HEALTH_DIR" -name "*.json" -mtime -7 | sort))
        ;;
    month)
        FILES=($(find "$HEALTH_DIR" -name "*.json" -mtime -30 | sort))
        ;;
    all)
        FILES=($(find "$HEALTH_DIR" -name "*.json" | sort))
        ;;
    *)
        echo "Usage: health-analyze [today|week|month|all]"
        exit 1
        ;;
esac

echo "=== Health Analysis: $TIMEFRAME ==="
echo ""

# Combine all files
COMBINED=$(mktemp)
echo "[]" > "$COMBINED"

for file in "${FILES[@]}"; do
    if [[ -f "$file" ]]; then
        jq -s '.[0] + .[1]' "$COMBINED" "$file" > "$COMBINED.tmp"
        mv "$COMBINED.tmp" "$COMBINED"
    fi
done

TOTAL=$(jq 'length' "$COMBINED")
echo "Total entries: $TOTAL"
echo ""

# Stress patterns
echo "--- STRESS LEVELS ---"
jq -r '.[] | select(.stress != null) | .stress' "$COMBINED" | sort | uniq -c | sort -rn

echo ""
echo "--- HEADACHES ---"
jq -r '.[] | select(.headache != null and .headache != "none") | "\(.timestamp) - \(.headache) \(if .trigger then "(\(.trigger))" else "" end)"' "$COMBINED"

echo ""
echo "--- SLEEP QUALITY ---"
jq -r '.[] | select(.quality != null) | "\(.timestamp | split("T")[0]) - Quality: \(.quality), Duration: \(.duration_hours // "?")"' "$COMBINED"

echo ""
echo "--- ENERGY PATTERNS ---"
jq -r '.[] | select(.energy != null) | .energy' "$COMBINED" | sort | uniq -c | sort -rn

echo ""
echo "--- COMMON TRIGGERS ---"
jq -r '.[] | select(.trigger != null) | .trigger' "$COMBINED" | sort | uniq -c | sort -rn

echo ""
echo "--- CORRELATIONS ---"
# High stress + headache correlation
HIGH_STRESS_WITH_HEADACHE=$(jq '[.[] | select(.stress == "high" or .stress == "severe") | select(.headache != null and .headache != "none")] | length' "$COMBINED")
HIGH_STRESS_TOTAL=$(jq '[.[] | select(.stress == "high" or .stress == "severe")] | length' "$COMBINED")

if [[ $HIGH_STRESS_TOTAL -gt 0 ]]; then
    HEADACHE_PERCENT=$((HIGH_STRESS_WITH_HEADACHE * 100 / HIGH_STRESS_TOTAL))
    echo "High stress events: $HIGH_STRESS_TOTAL"
    echo "High stress + headache: $HIGH_STRESS_WITH_HEADACHE ($HEADACHE_PERCENT%)"
fi

rm "$COMBINED"
