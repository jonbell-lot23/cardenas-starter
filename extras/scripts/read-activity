#!/bin/bash

# read-activity - Pull together activity data across date ranges
# Usage: ./read-activity [--today|--week|--month|--days N|--since YYYY-MM-DD|--range YYYY-MM-DD YYYY-MM-DD]

ACTIVITY_DIR="$HOME/cmd/tracker/activity/raw/daily"

show_help() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  --today              Show today's activity only"
    echo "  --week               Show last 7 days"
    echo "  --month              Show last 30 days" 
    echo "  --days N             Show last N days"
    echo "  --since YYYY-MM-DD   Show all activity since date"
    echo "  --range YYYY-MM-DD YYYY-MM-DD  Show activity between dates"
    echo "  --help               Show this help"
    echo ""
    echo "Examples:"
    echo "  $0 --today"
    echo "  $0 --days 11"
    echo "  $0 --since 2025-09-01"
    echo "  $0 --range 2025-09-09 2025-09-13"
}

# Date calculation functions
get_date_days_ago() {
    local days=$1
    if [[ "$OSTYPE" == "darwin"* ]]; then
        date -v-${days}d +%Y-%m-%d
    else
        date -d "${days} days ago" +%Y-%m-%d
    fi
}

parse_date_range() {
    local start_date="$1"
    local end_date="$2"
    
    # Convert dates to epoch for comparison
    if [[ "$OSTYPE" == "darwin"* ]]; then
        start_epoch=$(date -j -f "%Y-%m-%d" "$start_date" +%s 2>/dev/null)
        end_epoch=$(date -j -f "%Y-%m-%d" "$end_date" +%s 2>/dev/null)
    else
        start_epoch=$(date -d "$start_date" +%s 2>/dev/null)
        end_epoch=$(date -d "$end_date" +%s 2>/dev/null)
    fi
    
    if [[ -z "$start_epoch" || -z "$end_epoch" ]]; then
        echo "Error: Invalid date format. Use YYYY-MM-DD" >&2
        exit 1
    fi
    
    echo "$start_epoch $end_epoch"
}

# Process files in date range
process_files() {
    local start_epoch="$1"
    local end_epoch="$2"
    local found_data=false
    
    for file in "$ACTIVITY_DIR"/*.{json,md}; do
        [[ ! -f "$file" ]] && continue
        
        # Extract date from filename
        basename=$(basename "$file")
        file_date=$(echo "$basename" | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
        [[ -z "$file_date" ]] && continue
        
        # Convert file date to epoch
        if [[ "$OSTYPE" == "darwin"* ]]; then
            file_epoch=$(date -j -f "%Y-%m-%d" "$file_date" +%s 2>/dev/null)
        else
            file_epoch=$(date -d "$file_date" +%s 2>/dev/null)
        fi
        [[ -z "$file_epoch" ]] && continue
        
        # Check if file date is in range
        if [[ "$file_epoch" -ge "$start_epoch" && "$file_epoch" -le "$end_epoch" ]]; then
            echo "## $file_date"
            echo ""
            
            if [[ "$file" == *.json ]]; then
                # Handle JSON format
                if command -v jq >/dev/null 2>&1; then
                    jq -r '.[] | "- \(.time) - \(.activity)"' "$file" 2>/dev/null || {
                        # Fallback for malformed JSON
                        grep -o '"time":"[^"]*","activity":"[^"]*"' "$file" | sed 's/"time":"\([^"]*\)","activity":"\([^"]*\)"/- \1 - \2/'
                    }
                else
                    # No jq available, use grep
                    grep -o '"time":"[^"]*","activity":"[^"]*"' "$file" | sed 's/"time":"\([^"]*\)","activity":"\([^"]*\)"/- \1 - \2/'
                fi
            else
                # Handle markdown format
                cat "$file"
            fi
            echo ""
            found_data=true
        fi
    done
    
    if [[ "$found_data" == false ]]; then
        echo "No activity data found for the specified date range."
    fi
}

# Main logic
case "${1:-}" in
    --help|-h)
        show_help
        exit 0
        ;;
    --today)
        today=$(date +%Y-%m-%d)
        epochs=$(parse_date_range "$today" "$today")
        process_files $epochs
        ;;
    --week)
        start_date=$(get_date_days_ago 6)
        end_date=$(date +%Y-%m-%d)
        epochs=$(parse_date_range "$start_date" "$end_date")
        process_files $epochs
        ;;
    --month)
        start_date=$(get_date_days_ago 29)
        end_date=$(date +%Y-%m-%d)
        epochs=$(parse_date_range "$start_date" "$end_date")
        process_files $epochs
        ;;
    --days)
        if [[ -z "$2" || ! "$2" =~ ^[0-9]+$ ]]; then
            echo "Error: --days requires a number" >&2
            exit 1
        fi
        start_date=$(get_date_days_ago $(($2 - 1)))
        end_date=$(date +%Y-%m-%d)
        epochs=$(parse_date_range "$start_date" "$end_date")
        process_files $epochs
        ;;
    --since)
        if [[ -z "$2" ]]; then
            echo "Error: --since requires a date (YYYY-MM-DD)" >&2
            exit 1
        fi
        start_date="$2"
        end_date=$(date +%Y-%m-%d)
        epochs=$(parse_date_range "$start_date" "$end_date")
        process_files $epochs
        ;;
    --range)
        if [[ -z "$2" || -z "$3" ]]; then
            echo "Error: --range requires start and end dates (YYYY-MM-DD YYYY-MM-DD)" >&2
            exit 1
        fi
        epochs=$(parse_date_range "$2" "$3")
        process_files $epochs
        ;;
    "")
        echo "Error: No option specified. Use --help for usage." >&2
        exit 1
        ;;
    *)
        echo "Error: Unknown option '$1'. Use --help for usage." >&2
        exit 1
        ;;
esac