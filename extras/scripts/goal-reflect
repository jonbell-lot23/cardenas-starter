#!/bin/bash
set -euo pipefail

ROOT="$HOME/cmd/common/cardenas"
GOALS_FILE="$ROOT/goals/active.json"
REFLECTIONS_DIR="$ROOT/goals/reflections"
TODAY_FILE="$REFLECTIONS_DIR/$(date +%Y-%m-%d).json"

mkdir -p "$REFLECTIONS_DIR"

usage() {
    cat << 'EOF'
Goal-Reflect - Log progress against goals or note unaligned activities

USAGE:
    goal-reflect <goal-id> "<progress>"     Log progress against a goal
    goal-reflect --unaligned "<note>"       Note an unaligned activity
    goal-reflect --list                     Show today's reflections

EXAMPLES:
    goal-reflect g-2025-q1-fitness "Morning run completed - 5km"
    goal-reflect g-2025-12-ship-kaching-v1 "Got AMEX imports working"
    goal-reflect --unaligned "Spent 2 hours on Twitter"
    goal-reflect --list
EOF
}

log_reflection() {
    local goal_id="$1"
    local progress="$2"

    python3 << PYTHON
import json
import os
from datetime import datetime

goals_file = "$GOALS_FILE"
reflections_file = "$TODAY_FILE"
goal_id = "$goal_id"
progress = '''$progress'''

# Verify goal exists
with open(goals_file, 'r') as f:
    goals_data = json.load(f)

goal_title = None
for g in goals_data.get("goals", []):
    if g["id"] == goal_id:
        goal_title = g["title"]
        break

if not goal_title:
    print(f"Error: Goal not found: {goal_id}")
    exit(1)

# Load or create today's reflections
if os.path.exists(reflections_file):
    with open(reflections_file, 'r') as f:
        data = json.load(f)
else:
    data = {
        "date": datetime.now().strftime("%Y-%m-%d"),
        "reflections": [],
        "unaligned_activities": []
    }

# Add reflection
reflection = {
    "goal_id": goal_id,
    "progress": progress,
    "timestamp": datetime.now().isoformat()
}
data["reflections"].append(reflection)

# Save
with open(reflections_file, 'w') as f:
    json.dump(data, f, indent=2)

print(f"✓ Logged progress for: {goal_title}")
print(f"  {progress}")
PYTHON

    # Also track to main activity log
    ~/cmd/common/cardenas/track "Goal progress [$goal_id]: $progress"
}

log_unaligned() {
    local note="$1"

    python3 << PYTHON
import json
import os
from datetime import datetime

reflections_file = "$TODAY_FILE"
note = '''$note'''

# Load or create today's reflections
if os.path.exists(reflections_file):
    with open(reflections_file, 'r') as f:
        data = json.load(f)
else:
    data = {
        "date": datetime.now().strftime("%Y-%m-%d"),
        "reflections": [],
        "unaligned_activities": []
    }

# Add unaligned note
entry = {
    "note": note,
    "timestamp": datetime.now().isoformat()
}
data["unaligned_activities"].append(entry)

# Save
with open(reflections_file, 'w') as f:
    json.dump(data, f, indent=2)

print(f"✓ Noted unaligned activity:")
print(f"  {note}")
PYTHON

    # Also track to main activity log
    ~/cmd/common/cardenas/track "Unaligned activity noted: $note"
}

show_today() {
    python3 << PYTHON
import json
import os

reflections_file = "$TODAY_FILE"

if not os.path.exists(reflections_file):
    print("No reflections for today yet.")
    exit(0)

with open(reflections_file, 'r') as f:
    data = json.load(f)

print(f"=== Reflections for {data['date']} ===\n")

if data.get("reflections"):
    print("GOAL PROGRESS:")
    for r in data["reflections"]:
        time = r.get("timestamp", "")[:16].replace("T", " ")
        print(f"  [{time}] {r['goal_id']}")
        print(f"    → {r['progress']}")
else:
    print("No goal progress logged today.\n")

if data.get("unaligned_activities"):
    print("\nUNALIGNED ACTIVITIES:")
    for u in data["unaligned_activities"]:
        time = u.get("timestamp", "")[:16].replace("T", " ")
        print(f"  [{time}] {u['note']}")
PYTHON
}

# Main
if [[ $# -eq 0 ]]; then
    usage
    exit 0
fi

case "$1" in
    --unaligned)
        if [[ $# -lt 2 ]]; then
            echo "Error: Note required" >&2
            exit 1
        fi
        log_unaligned "$2"
        ;;
    --list)
        show_today
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        if [[ $# -lt 2 ]]; then
            echo "Error: Progress note required" >&2
            echo "Usage: goal-reflect <goal-id> \"<progress>\"" >&2
            exit 1
        fi
        log_reflection "$1" "$2"
        ;;
esac
