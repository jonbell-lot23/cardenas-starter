#!/bin/bash
# Quick health/mood logging tool
# Usage:
#   health-log mood stress=high anxiety=moderate
#   health-log symptom headache=severe trigger="long meeting"
#   health-log sleep quality=poor duration=5 interruptions=3
#   health-log check-in (prompts for current state)

set -euo pipefail

HEALTH_DIR="$HOME/cmd/cardenas/health-mood/daily"
TODAY=$(date +%Y-%m-%d)
HEALTH_FILE="$HEALTH_DIR/$TODAY.json"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S%z")

# Ensure directory exists
mkdir -p "$HEALTH_DIR"

# Initialize file if it doesn't exist
if [[ ! -f "$HEALTH_FILE" ]]; then
    echo "[]" > "$HEALTH_FILE"
fi

# Function to add entry
add_entry() {
    local entry_type="$1"
    shift

    # Build JSON entry
    local entry="{\"timestamp\":\"$TIMESTAMP\",\"type\":\"$entry_type\""

    # Parse key=value pairs
    for arg in "$@"; do
        if [[ $arg == *=* ]]; then
            key="${arg%%=*}"
            value="${arg#*=}"
            # Add quotes around value if it's not a number
            if [[ ! $value =~ ^[0-9]+$ ]] && [[ ! $value =~ ^(true|false)$ ]]; then
                value="\"$value\""
            fi
            entry="$entry,\"$key\":$value"
        fi
    done

    entry="$entry}"

    # Append to file using jq
    tmp=$(mktemp)
    jq ". += [$entry]" "$HEALTH_FILE" > "$tmp" && mv "$tmp" "$HEALTH_FILE"

    echo "✓ Health entry logged: $entry_type"
}

# Interactive check-in
check_in() {
    echo "=== Health Check-in ==="
    echo ""

    read -p "Stress level (low/medium/high/severe): " stress
    read -p "Energy level (exhausted/low/medium/high/energized): " energy
    read -p "Any headache? (none/mild/moderate/severe): " headache
    read -p "How's your mood? (describe): " mood_note
    read -p "Any context/triggers? " context

    local entry="{
        \"timestamp\":\"$TIMESTAMP\",
        \"type\":\"check_in\",
        \"stress\":\"$stress\",
        \"energy\":\"$energy\",
        \"headache\":\"$headache\",
        \"mood_note\":\"$mood_note\",
        \"context\":\"$context\"
    }"

    tmp=$(mktemp)
    jq ". += [$entry]" "$HEALTH_FILE" > "$tmp" && mv "$tmp" "$HEALTH_FILE"

    echo ""
    echo "✓ Check-in logged"

    # Also log to activity tracker
    ~/cmd/cardenas/track "Health check-in: stress=$stress, energy=$energy, headache=$headache. $mood_note"
}

# Main command handling
case "${1:-help}" in
    mood)
        shift
        add_entry "mood" "$@"
        ;;
    symptom)
        shift
        add_entry "symptom" "$@"
        ;;
    sleep)
        shift
        add_entry "sleep" "$@"
        ;;
    check-in)
        check_in
        ;;
    view)
        echo "=== Today's Health Log ==="
        jq '.' "$HEALTH_FILE"
        ;;
    help|*)
        echo "Health & Mood Logger"
        echo ""
        echo "Usage:"
        echo "  health-log mood stress=high anxiety=moderate"
        echo "  health-log symptom headache=severe trigger=\"long meeting\""
        echo "  health-log sleep quality=poor duration=5 interruptions=3"
        echo "  health-log check-in     # Interactive prompts"
        echo "  health-log view         # View today's log"
        echo ""
        echo "Quick examples:"
        echo "  health-log mood stress=high energy=low"
        echo "  health-log symptom headache=moderate"
        echo "  health-log sleep quality=good duration=7"
        ;;
esac
